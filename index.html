<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forge Calculator</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <main>
        <h1>Forge Calculator</h1>

        <!-- ORE ROWS -->
        <div class="ore-input-row">
            <div class="input-wrapper">
                <input type="text" id="name1" class="ore-search" placeholder="Select Ore #1">
                <button class="clear-btn" data-target="name1">×</button>
            </div>
            <input type="number" id="amt1" placeholder="Amount #1">
            <ul class="ore-options" id="options1"></ul>
        </div>

        <div class="ore-input-row">
            <div class="input-wrapper">
                <input type="text" id="name2" class="ore-search" placeholder="Select Ore #2">
                <button class="clear-btn" data-target="name2">×</button>
            </div>
            <input type="number" id="amt2" placeholder="Amount #2">
            <ul class="ore-options" id="options2"></ul>
        </div>

        <div class="ore-input-row">
            <div class="input-wrapper">
                <input type="text" id="name3" class="ore-search" placeholder="Select Ore #3">
                <button class="clear-btn" data-target="name3">×</button>
            </div>
            <input type="number" id="amt3" placeholder="Amount #3">
            <ul class="ore-options" id="options3"></ul>
        </div>

        <div class="ore-input-row">
            <div class="input-wrapper">
                <input type="text" id="name4" class="ore-search" placeholder="Select Ore #4">
                <button class="clear-btn" data-target="name4">×</button>
            </div>
            <input type="number" id="amt4" placeholder="Amount #4">
            <ul class="ore-options" id="options4"></ul>
        </div>

        <br>
        <label for="craft_type">Type:</label>
        <select id="craft_type">
            <option value="Weapon">Weapon</option>
            <option value="Armor">Armor</option>
        </select>

        <br><br>
        <button id="calculateBtn">Calculate</button>

        <h2 id="result"></h2>
    </main>

    <aside id="update-log">
        <h2>Update Log</h2>
        <ul>
            <li><strong>2025-11-29:</strong> Fixed Multi-Trait Scaling and Merged Output to 1 line per ore type..</li>
            <li><strong>2025-11-29:</strong> V1.0 Release of Calculator, Barebone No Styling. Multi Trait Scaling broken.</li>
            <li>@Otakusonline With Bug Information.</li>
        </ul>
    </aside>

    <script>
        let ores = {};
        let weaponOdds = {};
        let armorOdds = {};

        // Load JSON data
        Promise.all([
            fetch("ores.json").then(res => res.json()),
            fetch("weaponOdds.json").then(res => res.json()),
            fetch("armorOdds.json").then(res => res.json())
        ]).then(([oresData, wOdds, aOdds]) => {
            ores = oresData;
            weaponOdds = wOdds;
            armorOdds = aOdds;
            setupOreSearch(ores);
        }).catch(err => console.error("Failed to load JSON:", err));

        // Setup ore search inputs
        function setupOreSearch(ores) {
            const oreNames = Object.keys(ores);

            document.querySelectorAll(".ore-search").forEach((input, index) => {
                const optionsList = document.getElementById(`options${index + 1}`);

                oreNames.forEach(ore => {
                    const li = document.createElement("li");
                    li.textContent = ore;
                    li.addEventListener("click", () => {
                        input.value = ore;
                        optionsList.style.display = "none";
                    });
                    optionsList.appendChild(li);
                });

                input.addEventListener("input", () => {
                    const filter = input.value.toLowerCase();
                    let hasVisible = false;
                    optionsList.querySelectorAll("li").forEach(li => {
                        if (li.textContent.toLowerCase().includes(filter)) {
                            li.style.display = "";
                            hasVisible = true;
                        } else {
                            li.style.display = "none";
                        }
                    });
                    optionsList.style.display = hasVisible ? "block" : "none";
                });

                document.addEventListener("click", e => {
                    if (!input.contains(e.target) && !optionsList.contains(e.target)) {
                        optionsList.style.display = "none";
                    }
                });
            });
        }

        // Clear buttons logic
        document.querySelectorAll(".ore-search").forEach(input => {
            const clearBtn = input.parentElement.querySelector(".clear-btn");

            input.addEventListener("input", () => {
                clearBtn.style.display = input.value ? "block" : "none";
            });

            clearBtn.addEventListener("click", () => {
                input.value = "";
                clearBtn.style.display = "none";
                const listId = "options" + input.id.replace("name", "");
                const list = document.getElementById(listId);
                if (list) list.style.display = "none";
                input.focus();
            });
        });

        function calculateCombinedMultiplier(selectedOres) {
            let totalMultiplier = 0;
            let totalCount = 0;
            for (const [oreName, count] of Object.entries(selectedOres)) {
                if (!ores[oreName]) continue;
                totalMultiplier += ores[oreName].multiplier * count;
                totalCount += count;
            }
            return totalCount === 0 ? 0 : totalMultiplier / totalCount;
        }

        function calculateTransferredStat(x) {
            let y = 4.5 * x - 35;
            if (y < 0) y = 0;
            if (y > 100) y = 100;
            return y / 100;
        }

        function getItemChancesWithTraits(selectedOres, craftType = "Weapon") {
            const oddsDict = craftType === "Weapon" ? weaponOdds : armorOdds;
            const combinedMultiplier = calculateCombinedMultiplier(selectedOres);
            const totalCount = Object.values(selectedOres).reduce((a, b) => a + b, 0);
            const MAX_ODDS_ORE_COUNT = 55;
            const oddsKey = totalCount > MAX_ODDS_ORE_COUNT ? MAX_ODDS_ORE_COUNT : totalCount;
            const odds = oddsDict[oddsKey] || oddsDict[Math.max(...Object.keys(oddsDict))];

            const composition = {};
            for (const [ore, count] of Object.entries(selectedOres)) {
                composition[ore] = (count / totalCount * 100);
            }

            const traits = [];

            for (const [oreName, pct] of Object.entries(composition)) {
                const oreData = ores[oreName];
                if (!oreData || !Array.isArray(oreData.traits)) continue;

                if (oreData.traitType !== "All" && oreData.traitType !== craftType) continue;
                if (pct < 10) continue;

                const transferredFraction = calculateTransferredStat(pct);

                let oreTraitParts = [];

                for (let i = 0; i < oreData.traits.length; i++) {
                    const t1 = oreData.traits[i];
                    if (typeof t1.maxStat !== "number") continue;

                    const v1 = (transferredFraction * t1.maxStat).toFixed(2);
                    let line = `${v1}% ${t1.description}`;

                    // Merge sentence-style traits (like "with", "of", etc.)
                    let shouldMerge = t1.description.trim().match(/(with|of|for|per|to|in)$/i)
                        && oreData.traits[i + 1] && typeof oreData.traits[i + 1].maxStat === "number";

                    if (shouldMerge) {
                        const t2 = oreData.traits[i + 1];
                        const v2 = (transferredFraction * t2.maxStat).toFixed(2);
                        line += ` ${v2}% ${t2.description}`;
                        i++; // Skip next
                    }

                    oreTraitParts.push(line);
                }

                if (oreTraitParts.length) {
                    traits.push(oreTraitParts.join(", "));
                }
            }

            if (!traits.length) traits.push("No traits transfer");

            const highestOre = Object.entries(composition).reduce((a, b) => b[1] > a[1] ? b : a, ["", 0])[0];
            const rarity = ores[highestOre]?.rarity || "Unknown";

            const sortedOdds = Object.fromEntries(
                Object.entries(odds).filter(([k, v]) => v > 0)
                    .sort((a, b) => b[1] - a[1])
            );

            return {
                combinedMultiplier,
                totalCount,
                composition,
                odds: sortedOdds,
                traits,
                rarity
            };
        }

        document.getElementById("calculateBtn").addEventListener("click", () => {
            const selected = {};
            const invalidOres = [];
            const emptyOreIndexes = [];

            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`name${i}`).value.trim();
                const amt = parseFloat(document.getElementById(`amt${i}`).value);

                if (!name && !isNaN(amt) && amt > 0) emptyOreIndexes.push(i);
                if (name && !isNaN(amt) && amt > 0) {
                    if (ores[name]) selected[name] = amt;
                    else invalidOres.push(name);
                }
            }

            if (emptyOreIndexes.length > 0) {
                document.getElementById("result").innerText =
                    `⚠️ Please enter ore names for the following amount boxes: ${emptyOreIndexes.map(i => `#${i}`).join(", ")}`;
                return;
            }

            if (invalidOres.length > 0) {
                document.getElementById("result").innerText =
                    `⚠️ Invalid ore name(s): ${invalidOres.join(", ")}`;
                return;
            }

            const craftType = document.getElementById("craft_type").value;
            const totalCount = Object.values(selected).reduce((a, b) => a + b, 0);

            if (totalCount < 3) {
                document.getElementById("result").innerText = "⚠️ Can't Forge with less than 3 Ores!";
                return;
            }

            const result = getItemChancesWithTraits(selected, craftType);

            let output = "";
            if (totalCount > 55) {
                output += "⚠️ Ore total above 55! Showing stats for 55 ores only.\n\n";
            }

            output += `Rarity: ${result.rarity}\n`;
            output += `Combined Multiplier: ${result.combinedMultiplier.toFixed(2)}\n\nComposition:\n`;
            for (const [ore, pct] of Object.entries(result.composition)) {
                output += `  ${ore}: ${pct.toFixed(1)}%\n`;
            }

            output += `\nChances:\n`;
            for (const [key, val] of Object.entries(result.odds)) {
                output += `  ${key}: ${(val * 100).toFixed(1)}%\n`;
            }

            output += `\nTraits:\n  ${result.traits.join("\n  ")}`;

            document.getElementById("result").innerText = output;
        });
    </script>
    </main>
</body>

</html>